<html>
    <head>
        <style>
            * {
                box-sizing: border-box;
            }
            html, body {
                margin: 0;
                padding: 0;
                font-family: monospace;
                font-size: 14px;
            }
            .table {
                display: table;
                border-collapse: separate;
                border-spacing: 16px 8px;
                border: solid 1px gray;
                margin: 8px;
                border-radius: 8px;
            }
            .table > * {
                display: table-row;

            }
            .table > * > * {
                display: table-cell;
            }
            div {
                display: inline-block;
            }
            input[type=button]:not(:first-child) {
                margin-left: 8px;
            }
            #treatments::before {
                content: "Treatments:";
            }
            #result::before {
                content: "Results:";
            }
        </style>
    </head>
    <body>
        <div id="input" class="table"></div>
        <div id="treatments" class="table"></div>
        <div id="result" class="table"></div>
        <script>

            // everything in ms

            const input = document.getElementById('input');

            let treatments = [];

            const CURRENCY = '€';
            const MINUTE = 60 * 1000;
            const HOUR = 60 * MINUTE;

            const get_date = (text) => {
                const match = /(\d+):(\d+)/.exec(text);
                const today = new Date();
                today.setHours(parseInt(match[1]));
                today.setMinutes(parseInt(match[2]));
                return today;
            };

            const workingHours = () => {
                const start = get_date(document.getElementById('start-time').value);
                const end = get_date(document.getElementById('end-time').value);
                return (end - start) - (1 * HOUR);
            };

            const treatmentHours = () => {
                return [...document.getElementById('treatments').children].map(x => x.duration).reduce((a, b) => a + b, 0);
            };

            const extraTime = () => {

                const end = get_date(document.getElementById('end-time').value);

                if (end.getHours() < 19) {
                    return 0 * MINUTE;
                }

                if (end.getHours() == 19) {
                    if (end.getMinutes() < 15) {
                        return 15 * MINUTE;
                    }
                    if (end.getMinutes() < 30) {
                        return 30 * MINUTE;
                    }
                }

                return 45 * MINUTE;
            };

            const duration = ms => {
                const sec = ms / 1000;
                const hours = Math.floor(sec / 3600);
                const minutes = Math.floor((sec - hours * 3600) / 60);
                return `${hours}h ${minutes}m`;
            };

            const amount = v => {
                return `${v.toFixed(2)}${CURRENCY}`;
            }

            const evaluate = () => {
                const tTime = treatmentHours();
                const wTime = workingHours() - tTime;
                const eTime = extraTime();
                const wFare = parseFloat(document.getElementById('non-treatment-fare').value);
                const tFare = parseFloat(document.getElementById('treatment-fare').value);

                const wValue = (wTime / HOUR) * wFare;
                const eValue = (eTime / HOUR) * wFare;
                const tValue = (tTime / HOUR) * tFare;

                const total = wValue + tValue + eValue;

                const addEntry = (label, value) => {
                    const l = document.createElement('div');
                    l.innerText = label;
                    const v = document.createElement('div');
                    v.innerText = value;
                    const c = document.createElement('div');
                    c.append(l, v);
                    return c;
                };

                const result = document.getElementById('result');
                result.innerHTML = '';
                result.append(
                    addEntry('Working time', `${duration(wTime)} (${amount(wValue)})`),
                    addEntry('Treatment time', `${duration(tTime)} (${amount(tValue)})`),
                    addEntry('Extra time', `${duration(eTime)} (${amount(eValue)})`),
                    addEntry('Total', `${amount(total)}`)
                );
            };

            const addTreatment = (input) => {

                const createTreatmentEntry = (duration) => {
                    const container = document.createElement('div');
                    container.classList.add('treatment');
                    container.duration = duration;
                    const value = document.createElement('div');
                    value.innerText = `${duration / MINUTE} min.`;
                    const remove = document.createElement('input');
                    remove.setAttribute('type', 'button');
                    remove.value = 'Remove';
                    remove.onclick = () => {
                        container.remove();
                        evaluate();
                    };
                    container.append(value, remove);
                    return container;
                }

                document.getElementById('treatments').append(
                    createTreatmentEntry(input.target.duration)
                );

                evaluate();
            };

            const treatmentAdder = (name) => {
                const container = document.createElement('div');
                container.classList.add('input-group')
                const label = document.createElement('div')
                label.innerText = name;
                const choices = document.createElement('div');
                choices.style.display = 'inline-block';
                buttons = [15, 30, 45, 60, 90].map(x => x * MINUTE).map(duration => {
                    const button = document.createElement('input');
                    button.setAttribute('type', 'button');
                    button.value = `${duration / MINUTE} min.`;
                    button.duration = duration;
                    button.onclick = addTreatment;
                    return button;
                });
                choices.append(...buttons);
                container.append(label, choices);
                return container
            };

            function currency_field(id, value) {
                const input = document.createElement('input');
                input.input.setAttribute('type', 'text');
                input.input.setAttribute('id', id);
                return input;
            }

            const createField = (name, id, type, def) => {
                const container = document.createElement('div');
                container.classList.add('input-group')
                const label = document.createElement('div')
                label.innerText = name;
                const input = document.createElement('input');
                input.setAttribute('type', type);
                input.setAttribute('id', id);
                input.onchange = evaluate;
                if (def !== undefined) {
                    input.value = def;
                }
                container.append(label, input);
                return container
            };

            input.append(
                createField('Day of the week', 'day', 'day', 18.0),
                createField('Treatment fare (€)', 'treatment-fare', 'text', 18.0),
                createField('Non-Treatment fare (€)', 'non-treatment-fare', 'text', 10.5),
                createField('Start  time', 'start-time', 'time'),
                createField('End time', 'end-time', 'time'),
                treatmentAdder('Add a treatment')
            )
        </script>
    </body>
</html>